# Codex CLI 环境开发帮助文档（Open Spec 工作流）

这份文档用于把 Codex CLI 变成“可控、可审阅、可验证”的开发助手：先把目标写清，再让它小步交付，并在受限沙箱/需要审批的环境下稳定推进。

## 读完你将会
- 知道在 Codex CLI 中如何组织一次改动：**读上下文 → 澄清 → 计划 → 小步实现 → 验证 → 收尾**。
- 了解受限环境下（如网络受限、命令需审批）如何推进：哪些命令会被卡、怎么最小化阻塞。
- 拿到一组可直接复制的提示词模板，避免“一口气全做完”导致改动越界。

## 0. 快速开始（建议照做）
1) 在仓库根目录运行 Codex CLI，对话里先让它**只出计划不写代码**。  
2) 每一步都**限制允许修改的文件列表**，并要求给出**验证命令 + 预期结果**。  
3) 你在终端跑验证，把输出贴回对话；你在 Diff 里审阅是否越界。

你可以直接复制下面这一段作为开场：
```text
请先阅读本仓库与本任务相关的文档/目录结构（必要时再读 README、docs 下相关文件），先列出你需要澄清的 1–3 个问题。
然后给出 4–6 步计划：每一步写清要改哪些文件、怎么验证（终端命令）、预期结果。
在我回复“开始第 1 步”之前不要写任何代码/文档。
```

## 1. 你当前的 Codex CLI 运行限制（务必知道）
下面以常见配置举例（你可能会在 UI/日志里看到这些关键词）：

- `sandbox_mode=workspace-write`：允许读全仓库、只写工作区（例如本仓库目录）内文件；写到其他目录会被阻止或需要额外授权。
- `network_access=restricted`：任何需要联网的动作（例如安装依赖、拉远程资源）通常会触发审批或直接失败。
- `approval_policy=on-request`：当 Codex 需要执行“可能越权/联网/破坏性”的命令时，会请求你批准；你不批准，它就必须改用不需要审批的方案。

实用策略：
- 把“联网/安装依赖/大范围改动”拆出来单独做，并明确问你要不要批准。
- 优先让 Codex 做“读文件、改 Markdown、改小范围代码、生成验证命令”的工作；验证在本地终端完成。

### 审批时怎么判断要不要点“允许”
当 Codex 请求执行某条命令时，先快速过一遍：
- 是否联网（例如 `npm install`、`go get`、拉远程资源）？如果不是必须，先让它给离线替代方案。
- 是否会写到工作区外，或改动范围很大（生成大量文件/改锁文件）？要求它先说明影响面与回滚方式。
- 是否潜在破坏性（`rm`、`git reset --hard`、清空目录）？默认不批，除非你明确要做且已备份。
- 最佳实践：让它先“只打印命令 + 解释 + 预期输出”，你确认后再允许执行。

## 2. 推荐工作流（6 步）
1) 写 Spec：目标、范围/非范围、需求细项、验收标准、测试计划、约束、交付物。  
2) 让 Codex 阅读并提问：先读 Spec/代码，明确疑问再动手。  
3) 要计划：3–6 步，覆盖实现与测试；你确认后才执行。  
4) 小步实现：一次只做一小块；限制修改范围；改完解释“改了什么/为什么”。  
5) 验证：跑测试/构建/手动步骤，对照验收标准；失败先给最小修复方案。  
6) 收尾：总结改动、影响面、测试状态、剩余风险/待办。

### 推荐 Spec 模版（可直接复制）
```markdown
# 项目/需求名称
## 背景 & 目标
## 范围 / 非范围
- 范围：
- 非范围：
## 需求细项
- …
## 验收标准
- 正常/错误/边界场景（状态码、权限、UI 反馈等）
## 测试计划
- 自动化命令：
- 手动验证步骤：
## 约束 / 依赖
- 技术栈、兼容性、端口、API 契约、是否允许联网/安装依赖等
## 交付物
- 代码/文档/截图（可选）
```

## 3. 与 Codex 对话的“强约束”模板（可复制）
### 3.1 只要计划（不写代码）
```text
先不要写代码。请阅读我工作区里与本任务相关的文件（README/Spec/目录结构/关键入口文件），然后给出 4–6 步计划。
要求：每一步写清（要改哪些文件、怎么验证=终端命令、预期结果）。
我回复“开始第 1 步”后你再实现。
```

### 3.2 执行某一步（限制文件范围，避免越界）
```text
开始第 N 步。这一步只允许改这些文件：<填文件列表>。
不要引入新依赖；不要移动/重命名文件；不要做无关重构。
改完只交付：改动摘要 + 我看 diff 的 3 个点 + 终端验证命令（含预期成功标准）。
```

### 3.3 贴验证输出，让 Codex 判断是否通过
```text
我已运行你给的验证命令，输出如下（原样粘贴）：
<这里粘贴终端输出/报错>
请判断是否通过；如果没通过，给最小修复方案，并继续按“只改指定文件”的约束修复。
```

### 3.4 当需要联网/安装依赖时（先问再做）
```text
如果你需要安装依赖或做任何联网操作，请先说明原因、具体命令、会改动哪些文件/目录，以及失败时的回滚方式；
在我明确回复“批准”之前不要执行这些命令，先给一个不联网的备选方案（如果可能）。
```

## 4. 本仓库协作约定（建议遵循）
- 优先修改 Markdown 与 `image/` 资源，除非我明确要求改代码。
- 避免大改结构/大范围重写；改动要小而可回滚。
- 不要写入敏感信息（token/密码/私钥/DSN 等），示例用占位符或环境变量。
- 不要自动 `git commit`/`git push`，除非我明确要求。

## 5. 验证清单（你在终端做，输出贴回对话）
### 5.1 只改文档时
```bash
rg -n "TODO|FIXME|<INSTRUCTIONS>" -S docs || true
```
（可选）如果仓库有 Markdown lint/构建命令，优先用仓库现有脚本；不要为了 lint 新引入工具链。

### 5.2 改了代码/命令片段时
- 让 Codex 给出最小验证命令集（例如 `go test ./...`、`npm run build`、`python -m py_compile ...`）。
- 你运行后把摘要贴回去；失败时要求它“只改指定文件”最小修复。

## 6. OpenSpec CLI（可选，Fission-AI/OpenSpec）
注意：安装通常需要联网，在 `network_access=restricted` 下可能需要你批准或改用离线方案。

- 安装与初始化（需要联网）：
```bash
npm install -g @fission-ai/openspec@latest
openspec --version
openspec init
```
- 常用命令（精简版）：
```bash
openspec list
openspec show <change>
openspec validate <change>
openspec archive <change> --yes
```
- 典型流程：生成变更 → 审阅 → 逐项落实 tasks → 归档合并到 specs。

---

## 附录 A：Open Spec 示例（Go RBAC + Vue Web/H5）
下面示例保留作为“端到端演练材料”，用于练习：写 Spec → 计划 → 分步实现 → 验证 → 收尾。

### A.1 目标与栈
- 后端：用户注册/登录（JWT），角色/权限管理，受保护接口示例，SQLite 持久化。
- 前端：Vue3 + Vite + TypeScript + Pinia + Vue Router + Axios，Web/H5 响应式布局；提供登录、权限受控的 Demo 页面与角色/权限管理界面。

### A.2 初始化命令（你在终端执行）
```bash
# backend
mkdir rbac-demo && cd rbac-demo
go mod init rbac-demo
go get github.com/gin-gonic/gin gorm.io/gorm gorm.io/driver/sqlite github.com/golang-jwt/jwt/v4 golang.org/x/crypto/bcrypt

# frontend
mkdir frontend && cd frontend
npm create vite@latest . -- --template vue-ts
npm install
npm install axios pinia vue-router
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

### A.3 后端分步提示词（对话框）
```text
先不要写代码。请阅读项目根目录结构和 go.mod（我会打开），然后给出 4–6 步后端计划。
每一步写清：要改哪些文件、要提供哪些接口、怎么验证（终端命令）、预期结果。
```

示例（执行第 1 步，强约束）：
```text
开始后端计划第 1 步。这一步只允许改 main.go。
目标：先跑起来一个最小服务：SQLite 初始化 + 自动迁移 + /health 200 + 基础路由结构。
改完给：改动摘要 + Diff 审阅点 + 我在终端要跑的验证命令（含预期）。
```

验证命令示例：
```bash
go test ./...
go run .
curl -i http://127.0.0.1:8080/health
```

### A.4 前端分步提示词（对话框）
```text
先不要写代码。请阅读 frontend/package.json 和 src 目录结构（我会打开），给出 4–6 步前端计划：
路由/状态/API/页面/适配/构建（可选测试）。
每一步写清：要改哪些文件、怎么验证（终端命令）、预期结果。
```

验证命令示例：
```bash
npm run dev
npm run build
npm run preview
```

### A.5 验收与验证（示例）
- 后端：`/health` 200；登录得 token；无权限 403；角色/权限 CRUD 与分配可用；`/me` 返回角色/权限。
- 前端：无 token 访问受保护页自动跳转 `/login`；登录后能访问 Demo；窄屏不溢出；`npm run build && npm run preview` 成功。
